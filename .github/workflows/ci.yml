name: Lighthouse CI + Deploy Report

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device: [desktop, mobile]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Cache node modules
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Cài Playwright browsers (rất quan trọng, nếu thiếu sẽ exit code 2)
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      # Chạy Lighthouse CI
      - name: Run Lighthouse CI
        run: npx lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}  # nếu bạn dùng server

      # Upload báo cáo HTML làm artifact (để debug khi cần)
      - name: Upload Lighthouse report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report-${{ matrix.device }}
          path: |
            .lighthouseci/
            **/*.html

  deploy-pages:
    needs: lighthouse
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Tải lại toàn bộ artifact từ job lighthouse
      - name: Download all Lighthouse artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts
          pattern: lighthouse-report-*
          merge-multiple: true

      # Tạo thư mục _site để GitHub Pages deploy
      - name: Prepare GitHub Pages
        run: |
          mkdir -p _site
          cp -r downloaded-artifacts/.lighthouseci/* _site/ 2>/dev/null || echo "No reports yet"
          # Đảm bảo luôn có ít nhất 1 file để tránh lỗi "No artifacts"
          echo "<h1>Lighthouse Report</h1><p>Đang build...</p>" > _site/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4